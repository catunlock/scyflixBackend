<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SCYFLIX</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- Custom fonts for this template -->
    <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Cabin:700' rel='stylesheet' type='text/css'>

    <!-- Custom styles for this template -->
    <link href="css/grayscale.min.css" rel="stylesheet">
    <link href="css/manolito.css" rel="stylesheet">
    <script>

    	var searchResults;
    	var dict = {};
	   	function showTopic(s)
		{
		   var topics = '#'+s;
		   $(topics).show();
		}

		function hideTopic(s)
		{
		   var topics = '#'+s;
		   $(topics).hide();
		}

		var psr = '#resultados';
		$(psr).hide();
	    var x = document.cookie; 
	    var userName = x.substring(9, x.length);
	    var url = 'http://localhost:3000/getFirstRecomendation?user='+userName;
	    jQuery.support.cors = true;
	    $.ajax ({
	        url: url,
	        datatype: "json",
	        crossDomain: true,
	        success: function (data) {

				var i;
				var html ='<div class="carousel-inner" style = "min-height: 1000px;background-color: #white;"><div class="item active">';
				for (i=0; i < data.length && i < 3; ++i){
					var image1 = './img/'+data[i].id+'.png';
					var pdf1 = './pdfs/'+data[i].id+'.pdf';
					if (i != 0) html = html+'<div class="item">';
					//html = html + '<img onclick="clickImage("'+data[i].id+'");" src="'+image1+'" style="width: 100%"></div></a>';
					html = html + '<img onclick="clickImage(\''+data[i].id+'\');" src="'+image1+'" style="width: 100%"></div>';
				}
				html = html + '</div>';
				document.getElementById("carrousel").innerHTML = html;
	        }
	    });

	    url = 'http://localhost:3000/getClusters'
	    jQuery.support.cors = true;
	    $.ajax ({
	        url: url,
	        datatype: "json",
	        crossDomain: true,
	        success: function (data) {

				var html = "";
				var i;
				var mustBeHidden = [];
				nameDict = {};
				nameDict['AI'] = 'INTELIGENCIA ARTIFICIAL';
				nameDict['LG'] = 'APRENDIZAJE AUTOMÁTICO';
				nameDict['CR'] = 'CRIPTOGRAFÍA';
				nameDict['CV'] = 'VISIÓN POR COMPUTADOR'
				nameDict['DB'] = 'BASES DE DATOS'
				nameDict
				for (i = 0; i < data.length; ++i){
					var cat = data[i].category.substring(data[i].category.length - 2, data[i].category.length);
					html = html + '<div onmouseover="showTopic(\''+cat+'topics\');" onmouseout="hideTopic(\''+cat+'topics\');" >';
			        html = html + '   <div id = "category" class="btn-default" tag = "'+cat+'" style = "padding: 10px;text-align: center;">'
			        html = html + nameDict[cat]; //USAR DICCIONARIO
			        html = html + '   </div>';
					html = html + '   <div id = "'+cat+'" class="btn-inner ">';
					//TOPICS - INI
					html = html + '<div onmouseover="showTopic(\''+cat+'topics\');" onmouseout="hideTopic(\''+cat+'topics\');" >';
					html = html + '<div id ="'+cat+'topics">'
					mustBeHidden.push('#'+cat+'topics');
					for (var cluster in data[i].clusters){
						var j = cluster;
						var topic  = 'topic'+cat+j;
						html = html + '		<div id = "'+topic+'" style = "border-style: solid;" onmouseover="showTopic(\''+cat+'topics\');" onmouseout="hideTopic(\''+cat+'topics\');"><h1>Palabras clave del cluster: ';
						var keyWords;
						for (keyWords = data[i].clusters[cluster].keywords.length - 5; keyWords < data[i].clusters[cluster].keywords.length ; ++keyWords){
							if (data[i].clusters[cluster].keywords[keyWords] != undefined){
								html = html + data[i].clusters[cluster].keywords[keyWords][1] + ' ';
							}
						}
						html = html + '			</h1><div id ="papersCluster'+cluster+'"';
						//PAPERS DEL CLUSTER - INI
						for (var papers in data[i].clusters[cluster].documents){
							if (data[i].clusters[cluster].documents[papers].title != ''){
								html = html + '<div onmouseover="showPaper(\'paper'+papers+'Cluster'+i+'_'+cluster+'\', \''+data[i].clusters[cluster].documents[papers].id+'\');" onmouseout="hidePaper(\'paper'+papers+'Cluster'+i+'_'+cluster+'\');"  id = "'+data[i].clusters[cluster].documents[papers].id+'" class="btn-inner" style ="margin-top:20px; margin-left:100px; font-size: 3rem;">';							
	      						html = html + '· '+data[i].clusters[cluster].documents[papers].title;
	      						html = html + '<div id="paper'+papers+'Cluster'+i+'_'+cluster+'" class="btn-inner" style = "font-size: 0.8rem; margin-left:60px; margin-top:20px;">';//
	      						mustBeHidden.push('#'+'paper'+papers+'Cluster'+i+'_'+cluster);
	      						//FICHA DEL PAPER - INI
	      						html = html +"<p class='btn-inner'>Fecha publicación</p><p style ='margin-left:110px;'>"+data[i].clusters[cluster].documents[papers].published.substring(0, 10)+"</p>";
	      						html = html +'<div style = "background-color:#FFFFFF;width: 70%;margin:auto"><img class="carousel-inner" onclick="clickImage(\''+data[i].clusters[cluster].documents[papers].id+'\');" src="./img/'+data[i].clusters[cluster].documents[papers].id+'.png" style="width: 100%;"></div>';
	      						html = html + '<div class="btn-inner" style ="margin-top:20px; font-size: 1.5rem;">';//
	      						html = html + 'Artículos más similares';
					            html = html + '<div class="col-sm-8e" id ="Cards" style="background-color:#FFFFFF; border-radius: 20px; margin: auto; width:60%">'//
					            html = html +    '<div id="myCarouselpaper'+papers+'Cluster'+i+'_'+cluster+'" class="carousel slide" data-ride="carousel">'//
					            html = html +        '<div id = "carrouselpaper'+papers+'Cluster'+i+'_'+cluster+'">' //                   	
					            html = html +        '</div>'//

					            html = html +        '<a class="left carousel-control" href="#myCarousel'+papers+'" data-slide="prev">'
					            html = html +          '<span class="glyphicon glyphicon-chevron-left"></span>'
					            html = html +          '<span class="sr-only">Previous</span>'
					            html = html +        '</a>'
					            html = html +        '<a class="right carousel-control" href="#myCarousel'+papers+'" data-slide="next">'
					            html = html +          '<span class="glyphicon glyphicon-chevron-right"></span>'
					            html = html +          '<span class="sr-only">Next</span>'
					            html = html +        '</a>'
					            html = html +    '</div>'//
					            html = html + '</div>'// 
					            html = html + '</div>'//
								html = html + '</div>'//

	      						html = html + '</div>'//	
	      					}						
						}
						//PAPERS DEL CLUSTER - FIN
						//html = html + '			</div>'
						html = html + '		</div>';					
					}
					html = html + '</div>';
					html = html + '</div>';
					//html = html + '<script>$(\'#'+cat+'topics\').hide();<\/script>';
					//TOPICS - FIN
					html = html + '	  </div>';
					//html = html + '<script>$(\'#topics'+cat+'\').hide();<\/script>';
					html = html + '</div>';
				}
				document.getElementById("menu").innerHTML = html;
				for (var hide in mustBeHidden){
					$(mustBeHidden[hide]).hide();
				}
	        }
	    });

	    function getRelated(j,id){
	    	var url = 'http://localhost:3000/getThreeSimilar?paper='+id;
		    jQuery.support.cors = true;
		    $.ajax ({
		        url: url,
		        datatype: "json",
		        crossDomain: true,
		        success: function (data) {

					var i;
					if (data.length > 0){
						var html ='<div id="myCarousel'+j+'" class="carousel slide" data-ride="carousel"><div class="carousel-inner" style = "min-height: 1000px;"><div class="item active">';
						for (i=0; i < data.length && i < 3; ++i){
							var image1 = './img/'+data[i].id+'.png';
							var pdf1 = './pdfs/'+data[i].id+'.pdf';
							if (i != 0) html = html+'<div class="item">';
							html = html + '<img onclick="clickImage(\''+data[i].id+'\');" src="'+image1+'" style="width: 100%"></div>';
						}
						html = html + '</div></div>';
						document.getElementById('carrousel'+j).innerHTML = html;
					}
		        }
		    });	
	    }
	    function clickImage(a) {
	      var paperId = a;
	      var x = document.cookie; 
	      var userName = x.substring(9, x.length);
	      var url = 'http://localhost:3000/updateLastPaper?user='+userName+'&paper='+paperId;
	      jQuery.support.cors = true;
	      $.ajax ({
	          url: url,
	          datatype: "json",
	          crossDomain: true,
	          success: function (data) {
	            alert("DB updated");
	          }
	      });
	      var win = window.open('./pdfs/'+a+'.pdf', '_blank');
	      win.focus();
	    }

	    function showPaper(i, id){
	    	if (dict[id] == undefined){
	    		getRelated(i,id);
	    		dict[id] = 1;
	    	}
			var p = '#'+i;
			$(p).show();
	    }


	    function hidePaper(i){
			var p = '#'+i;
			$(p).hide();
	    }
	    function searchSimilar(){
	    	var path = '/home/segmentation-fault/uni/PAE/scyflixBackend/webPage/testPdfs/'+document.getElementById("fileInput").files[0].name; //POR MOTIVOS DE SEGURIDAD EL EXPLORADOR NO TE DEVUELVE LA RUTA, HABRA QUE ESCOGER PAPERS QUE ESTEN EN EL DIRECTORIO ./testPdfs
	    	//OJO!! -> CAMBIAR ./ por ruta absoluta 
			var url = 'http://localhost:3000/getSimilarFromPdf?file='+path;
			jQuery.support.cors = true;
			$.ajax ({
				url: url,
				datatype: "json",
				crossDomain: true,
			success: function (data) {
						var i;
						var html = "";
						for (i = 0; i < data.length; ++i){
							html = html + '<div onmouseover="showPaper(\'paper'+i+'\', \''+data[i].id+'\');" onmouseout="hidePaper(\'paper'+i+'\');"  id = "'+data[i].id+'" class="btn-inner" style ="margin-top:20px; font-size: 3rem;">';
      						html = html + '· '+data[i].title;
      						html = html + '<div id="paper'+i+'" class="btn-inner" style = "font-size: 0.8rem; margin-left:60px; margin-top:20px;">';
      						//FICHA DEL PAPER - INI
      						html = html +"<p class='btn-inner'>Autor</p><p style ='margin-left:110px;'>"+data[i].author+"</p>";
      						html = html +"<p class='btn-inner'>Fecha publicación</p><p style ='margin-left:110px;'>"+data[i].published.substring(0, 10)+"</p>";
      						html = html +'<div style = "background-color:#FFFFFF;width: 70%;margin:auto"><img class="carousel-inner" onclick="clickImage(\''+data[i].id+'\');" src="./img/'+data[i].id+'.png" style="width: 100%;"></div>';
      						html = html + '<div class="btn-inner" style ="margin-top:20px; font-size: 1.5rem;">';//
      						html = html + 'Artículos más similares';
				            html = html + '<div class="col-sm-8e" id ="Cards" style="background-color:#FFFFFF; border-radius: 20px; margin: auto; width:60%">'//
				            html = html +    '<div id="myCarouselpaper'+i+'" class="carousel slide" data-ride="carousel">'//
				            html = html +        '<div id = "carrouselpaper'+i+'">' //                   	
				            html = html +        '</div>'//

				            html = html +        '<a class="left carousel-control" href="#myCarousel'+i+'" data-slide="prev">'
				            html = html +          '<span class="glyphicon glyphicon-chevron-left"></span>'
				            html = html +          '<span class="sr-only">Previous</span>'
				            html = html +        '</a>'
				            html = html +        '<a class="right carousel-control" href="#myCarousel'+i+'" data-slide="next">'
				            html = html +          '<span class="glyphicon glyphicon-chevron-right"></span>'
				            html = html +          '<span class="sr-only">Next</span>'
				            html = html +        '</a>'
				            html = html +    '</div>'//
				            html = html + '</div>'// 
				            html = html + '</div>'//
							html = html + '</div>'//

      						html = html + '</div>'//

      						
						}
						var psr = '#resultados';
						$(psr).show();
						document.getElementById("papersFound").innerHTML = html;
						searchResults = data;
						for (i = 0; i < data.length; ++i) $('#paper'+i).hide();
						window.location.hash = "resultados";
					}
			});	    	
	    }
	    function filtrar(){
	    	var fechaDesde = document.getElementById("fechaDesde").value;
	    	var fechaHasta = document.getElementById("fechaHasta").value;
	    	var texto = document.getElementById("texto").value;
	    	var autor = document.getElementById("autor").value;;
	    	var query = "";
	    	if (fechaDesde != "") query = query+'from='+fechaDesde+"&";
	    	if (fechaHasta != "") query = query+'to='+fechaHasta+"&";
	    	if (autor != "") query = query+'autor='+autor+"&";
	    	if (texto != "") query = query+'text='+texto+"&";
	    	if (query == ""){
	    		alert("Se debe informar algún criterio de filtrado.")
	    	}else{
		    	var url = 'http://localhost:3000/query?'+query;
				jQuery.support.cors = true;
				$.ajax ({
					url: url,
					datatype: "json",
					crossDomain: true,
					success: function (data) {
						var i;
						var html = "";
						for (i = 0; i < data.length; ++i){
							html = html + '<div onmouseover="showPaper(\'paper'+i+'\', \''+data[i].id+'\');" onmouseout="hidePaper(\'paper'+i+'\');"  id = "'+data[i].id+'" class="btn-inner" style ="margin-top:20px; font-size: 3rem;">';      	
							html = html + '· '+data[i].title;
      						html = html + '<div id="paper'+i+'" class="btn-inner" style = "font-size: 0.8rem; margin-left:60px; margin-top:20px;">';//
      						//FICHA DEL PAPER - INI
      						html = html +"<p class='btn-inner'>Autor</p><p style ='margin-left:110px;'>"+data[i].author+"</p>";
      						html = html +"<p class='btn-inner'>Fecha publicación</p><p style ='margin-left:110px;'>"+data[i].published.substring(0, 10)+"</p>";
      						html = html +'<div style = "background-color:#FFFFFF;width: 70%;margin:auto"><img class="carousel-inner" onclick="clickImage(\''+data[i].id+'\');" src="./img/'+data[i].id+'.png" style="width: 100%;"></div>';
      						html = html + '<div class="btn-inner" style ="margin-top:20px; font-size: 1.5rem;">';//
      						html = html + 'Artículos más similares';
				            html = html + '<div class="col-sm-8e" id ="Cards" style="background-color:#FFFFFF; border-radius: 20px; margin: auto; width:60%">'//
				            html = html +    '<div id="myCarousel'+i+'" class="carousel slide" data-ride="carousel">'//
				            html = html +        '<div id = "carrousel'+i+'">' //                   	
				            html = html +        '</div>'//

				            html = html +        '<a class="left carousel-control" href="#myCarousel'+i+'" data-slide="prev">'
				            html = html +          '<span class="glyphicon glyphicon-chevron-left"></span>'
				            html = html +          '<span class="sr-only">Previous</span>'
				            html = html +        '</a>'
				            html = html +        '<a class="right carousel-control" href="#myCarousel'+i+'" data-slide="next">'
				            html = html +          '<span class="glyphicon glyphicon-chevron-right"></span>'
				            html = html +          '<span class="sr-only">Next</span>'
				            html = html +        '</a>'
				            html = html +    '</div>'//
				            html = html + '</div>'// 
				            html = html + '</div>'//
							html = html + '</div>'//

      						html = html + '</div>'//

      						
						}
						var psr = '#resultados';
						$(psr).show();
						document.getElementById("papersFound").innerHTML = html;
						searchResults = data;
						for (i = 0; i < data.length; ++i) $('#paper'+i).hide();
						window.location.hash = "resultados";
					}
				})
			}
	    }
    </script>
  </head>

  <body id="page-top" background="background.png">
   <div id="papers" class="content-section text-center" style ="margin-bottom: 1px">
      <div class="container">
        <div class="row">
       		<h4 style = "font-size: 400%;">BIENVENIDO A SCIFLIX</h4>
          <div class="col-lg-8e mx-auto">
            <h2 style = "font-size: 200%;">Recomendados para ti</h2>


            <!-- The slideshow -->
            <div class="col-sm-8e" id ="Cards" style="background-color:#FFFFFF; border-radius: 20px; margin: auto; width:60%">
                <div id="myCarousel" class="carousel slide" data-ride="carousel">
                    <div id = "carrousel">                    	
                    </div>
                    <!-- Left and right controls -->
                    <a class="left carousel-control" href="#myCarousel" data-slide="prev">
                      <span class="glyphicon glyphicon-chevron-left"></span>
                      <span class="sr-only">Previous</span>
                    </a>
                    <a class="right carousel-control" href="#myCarousel" data-slide="next">
                      <span class="glyphicon glyphicon-chevron-right"></span>
                      <span class="sr-only">Next</span>
                    </a>
                </div>
            </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="Sector1 " class="content-section" style="margin-top: 1px">
     	<div class="container">
     	<div class="dropdown" style="margin: 10px;font-size: 200%;">FILTRO DE BÚSQUEDA</div>
        <div class="dropdown" style="min-width: 850px;border: 1px; border-color: white; border-style: solid; padding: 10px; width: 100%;">
        	<div style = "width: 33%; float: left;">
	    		<div style="margin: 10px;font-size: 100%;">VER DESDE</div>
	    		<input type="date" id="fechaDesde" class="btn-default" >
	    		<div style="margin: 10px;font-size: 100%;">HASTA</div>
	    		<input type="date" id="fechaHasta" class="btn-default">
    		</div>
    		<div style = "width: 33%;float: left;">
	    		<div style="margin: 10px;font-size: 100%;">AUTOR</div>
	    		<input type="text" id="autor" class="btn-default" >
	    		<div style="margin: 10px;font-size: 100%;">TEXTO</div>
	    		<input type="text" id="texto" class="btn-default">
    		</div>
    		<div style = "width: 33%;float: right;">
	    		<div style="margin: 10px;font-size: 100%;">CATEGORÍA</div>
	    		<label class="btn-default" style = "width: 100%; border-style: none"><input type="checkbox" name="cb1"> APRENDIZAJE AUTOMÁTICO</label>
	    		<label class="btn-default" style = "width: 100%;border-style: none"><input type="checkbox" name="cb2"> INTELIGENCIA ARTIFICIAL</label>
	    		<label class="btn-default" style = "width: 100%;border-style: none"><input type="checkbox" name="cb3"> BASES DE DATOS</label>
	    		<label class="btn-default" style = "width: 100%;border-style: none"><input type="checkbox" name="cb3"> CRIPTOGRAFÍA</label>
	    		<label class="btn-default" style = "width: 100%;border-style: none"><input type="checkbox" name="cb3"> VISIÓN POR COMPUTADOR</label>
    		</div>
    		  		
    		<div style = "width: 100%; float:right;">
    		<button id="btnSubmit" class="btn-default" onclick="filtrar()" style="margin:50px;float:right;">Filtrar</button>
    		</div>

    	</div>
    	<div class = "dropdown">
			<label>Buscar similares a un artículo:<input id="fileInput" type="file" onchange="searchSimilar()"></label>
		</div>  
        <div class="row">
          <!-- Left Col -->

	            <div class="dropdown">
	            	<br>
	            	<div style="margin: 10px;font-size: 200%;">CATEGORÍAS</div><br>
	            	<div id="menu">

					</div>
	            </div>


            
      	</div>
      	<div class="dropdown" id="resultados">
      		<div style="margin: 10px;font-size: 200%;">RESULTADOS BÚSQUEDA</div><br>
      		<div id ="papersFound">
      		</div>
      	</div>
    </div>
    </div>

  

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Google Maps API Key - Use your own API key to enable the map feature. More information on the Google Maps API can be found at https://developers.google.com/maps/ -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCRngKslUGJTlibkQ3FkfTxj3Xss1UlZDA&sensor=false"></script>

    <!-- Custom scripts for this template -->
    <script src="js/grayscale.min.js"></script>

  </body>

</html>
